#!/bin/bash

set -e
set -o pipefail

LATEST=node7.dockerfile

for DOCKERFILE in dockerfiles/*.dockerfile; do
	CONFIG=$(cat $DOCKERFILE)
	TAG=""

	if [[ $CONFIG =~ node:([0-9\.]+) ]]; then
		TAG=${BASH_REMATCH[1]}
	else
		echo "Could not find version"
		exit 1
	fi

	echo "Building $DOCKERFILE"
	docker build --no-cache -t juliusworks/node-alpine-yarn:$TAG -f $DOCKERFILE .

	if [ "$(basename $DOCKERFILE)" == "$LATEST" ]; then
		echo "Tagging $DOCKERFILE as latest"
		docker tag juliusworks/node-alpine-yarn:$TAG juliusworks/node-alpine-yarn:latest
	fi


	echo "Pushing $DOCKERFILE"
	docker push juliusworks/node-alpine-yarn:$TAG

	if [ "$(basename $DOCKERFILE)" == "$LATEST" ]; then
		docker push juliusworks/node-alpine-yarn:latest
	fi
done
